---
title: "R Notebook"
output: html_notebook
---
### Loading libraries 
```{r}
# Load required libraries
if (!requireNamespace("Biostrings", quietly = TRUE)) {
  install.packages("BiocManager")
  BiocManager::install("Biostrings")}

if (!requireNamespace("ggplot2", quietly = TRUE)) {
  install.packages("ggplot2")}
library(Biostrings)
library(ggplot2)
```







# Function to calculate CpG island statistics
find_cpg_islands <- function(sequence, window_size = 200, step_size = 50, gc_threshold = 50, cpg_ratio_threshold = 0.6) {
  # Initialize result list
  cpg_islands <- data.frame(Start = integer(), End = integer(), GC_Content = numeric(), CpG_Ratio = numeric())
  
  # Loop through the sequence using a sliding window
  for (start_pos in seq(1, width(sequence) - window_size + 1, by = step_size)) {
    end_pos <- start_pos + window_size - 1
    window_seq <- subseq(sequence, start = start_pos, end = end_pos)
    
    # Calculate GC content
    gc_count <- sum(letterFrequency(window_seq, c("G", "C")))
    gc_content <- (gc_count / width(window_seq)) * 100
    
    # Calculate observed-to-expected CpG ratio
    c_count <- letterFrequency(window_seq, "C")
    g_count <- letterFrequency(window_seq, "G")
    cpg_count <- countPattern("CG", window_seq)
    expected_cpg <- (c_count * g_count) / width(window_seq)
    cpg_ratio <- ifelse(expected_cpg > 0, cpg_count / expected_cpg, 0)
    
    # Check if it meets CpG island criteria
    if (gc_content >= gc_threshold && cpg_ratio >= cpg_ratio_threshold) {
      cpg_islands <- rbind(cpg_islands, data.frame(Start = start_pos, End = end_pos, GC_Content = gc_content, CpG_Ratio = cpg_ratio))
    }
  }
  return(cpg_islands)
}

# Main function to scan a genome FASTA file
scan_genome_for_cpg_islands <- function(fasta_file, window_size = 200, step_size = 50, gc_threshold = 50, cpg_ratio_threshold = 0.6) {
  # Read genome from FASTA file
  genome <- readDNAStringSet(fasta_file)
  all_cpg_islands <- data.frame(Sequence = character(), Start = integer(), End = integer(), GC_Content = numeric(), CpG_Ratio = numeric())
  
  # Process each sequence in the genome
  for (seq_name in names(genome)) {
    cat("Scanning sequence:", seq_name, "\n")
    sequence <- genome[[seq_name]]
    cpg_islands <- find_cpg_islands(sequence, window_size, step_size, gc_threshold, cpg_ratio_threshold)
    cpg_islands$Sequence <- seq_name
    all_cpg_islands <- rbind(all_cpg_islands, cpg_islands)
  }
  
  return(all_cpg_islands)
}

# Visualization function
visualize_cpg_islands <- function(cpg_islands) {
  ggplot(cpg_islands, aes(x = Start, y = GC_Content, color = Sequence)) +
    geom_point(size = 2) +
    geom_segment(aes(xend = End, yend = GC_Content), size = 1) +
    labs(title = "CpG Islands in Genome", x = "Position (bp)", y = "GC Content (%)") +
    theme_minimal() +
    theme(legend.position = "bottom")
}

# Example usage
# Replace "path/to/your/genome.fasta" with the path to your FASTA file
fasta_file <- "C:/Users/Charles.Gumbi/Work/POP_genome/ragtag.scaffold.fasta"

# Scan the genome for CpG islands
cpg_islands <- scan_genome_for_cpg_islands(fasta_file)

# Save results to a file
write.table(cpg_islands, "cpg_islands_results.txt", row.names = FALSE, sep = "\t")

# Visualize the CpG islands
if (nrow(cpg_islands) > 0) {
  cpg_plot <- visualize_cpg_islands(cpg_islands)
  print(cpg_plot)
} else {
  cat("No CpG islands found in the genome.\n")
}
